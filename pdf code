package your.package.name;

import io.cucumber.java.After;
import io.cucumber.java.Before;
import io.cucumber.java.Scenario;

import java.awt.Desktop;
import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStream;
import java.util.concurrent.atomic.AtomicInteger;

import com.openhtmltopdf.pdfboxout.PdfRendererBuilder;

public class Hooks {

    private static final AtomicInteger scenarioCounter = new AtomicInteger(0);
    private static final int TOTAL_SCENARIOS = 10; // Replace with actual scenario count if known

    @Before
    public void beforeScenario(Scenario scenario) {
        // Optional: delete flag file before first run
        File flag = new File("reportGenerated.flag");
        if (flag.exists()) flag.delete();
    }

    @After
    public void afterScenario(Scenario scenario) {
        // Your usual post-scenario logic (e.g., screenshot on failure)
        // ...

        // At the end of the last scenario, convert HTML to PDF and open it
        if (scenarioCounter.incrementAndGet() == TOTAL_SCENARIOS) {
            generateExtentReportPdf();
        }
    }

    private void generateExtentReportPdf() {
        try {
            File flag = new File("reportGenerated.flag");
            if (flag.exists()) return;

            String inputHtmlPath = new File("target/extent-report/ExtentReport.html").getAbsolutePath();
            String outputPdfPath = "target/extent-report/ExtentReport.pdf";

            try (OutputStream os = new FileOutputStream(outputPdfPath)) {
                PdfRendererBuilder builder = new PdfRendererBuilder();
                builder.useFastMode();
                builder.withUri("file:///" + inputHtmlPath.replace("\\", "/"));
                builder.toStream(os);
                builder.run();
                System.out.println("✅ Extent PDF Report generated.");

                // Optional: open the report
                File pdfFile = new File(outputPdfPath);
                if (pdfFile.exists()) {
                    Desktop.getDesktop().open(pdfFile);
                }
            }

            // Create flag to prevent duplicate conversion
            flag.createNewFile();
        } catch (Exception e) {
            System.err.println("❌ Failed to generate or open PDF Extent Report.");
            e.printStackTrace();
        }
    }
}
